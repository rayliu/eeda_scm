package controllers.eeda;import java.util.Calendar;import java.util.Date;import java.util.LinkedHashMap;import java.util.List;import java.util.Map.Entry;import java.util.Set;import models.Party;import models.PartyAttribute;import models.UserLogin;import org.apache.shiro.SecurityUtils;import org.apache.shiro.subject.Subject;import com.jfinal.core.Controller;import com.jfinal.log.Logger;import com.jfinal.plugin.activerecord.Db;public class PropertyClientController extends Controller {	private Logger logger = Logger.getLogger(PropertyClientController.class);	Subject currentUser = SecurityUtils.getSubject();	private boolean isAuthenticated() {		if (!currentUser.isAuthenticated()) {			redirect("/login");			return false;		}		setAttr("userId", currentUser.getPrincipal());		return true;	}	public void index() {		if (!isAuthenticated())			return;		List<Party> partyList = Party.dao.find("select * from party where party_type ='地产客户' order by create_date desc");		System.out.println("size:" + partyList.size());		List<UserLogin> userList = UserLogin.dao.find("select * from user_login order by user_name");		setAttr("userList", userList);		setAttr("clientList", partyList).render("/eeda/propertyClient/list.html");	}	public void edit() {		if (!isAuthenticated())			return;		String id = getPara();		if (id != null) {			Party p = Party.dao.findById(id);			setAttr("party", p);		}		String queryString = getRequest().getQueryString() == null ? "" : getRequest().getQueryString();		setAttr("userId", currentUser.getPrincipal());		setAttr("queryString", queryString);		render("/eeda/propertyClient/edit.html");	}	public void save() {		if (!isAuthenticated())			return;		Party party = null;		String id = getPara("id");		if (id != "") {			party = Party.dao.findById(id);		} else {			party = new Party();		}		if (id != "") {			Db.update("delete from party_attribute where party_id=?", id);			party.update();		} else {			Date createDate = Calendar.getInstance().getTime();			party.set("party_type", "地产客户").set("create_date", createDate).set("creator", currentUser.getPrincipal()).save();			id = String.valueOf(party.get("id"));		}		LinkedHashMap<String, String> map = new LinkedHashMap<String, String>();		map.put("title", getPara("title"));		map.put("client_name", getPara("client_name"));		map.put("priority", getPara("priority"));		map.put("status", getPara("status"));		map.put("type", getPara("type"));		map.put("region", getPara("region"));		map.put("area", getPara("area"));		map.put("total", getPara("total"));		map.put("career", getPara("career"));		map.put("intro", getPara("intro"));		map.put("follow_info", getPara("follow_info"));		map.put("introducer", getPara("introducer"));		map.put("customer_source", getPara("customer_source"));		map.put("sales", getPara("sales"));		map.put("follower", getPara("follower"));		map.put("follower_phone", getPara("follower_phone"));		map.put("client_phone1", getPara("client_phone1"));		map.put("client_phone2", getPara("client_phone2"));		map.put("client_phone3", getPara("client_phone3"));		Set<Entry<String, String>> paSet = map.entrySet();		for (Entry<String, String> entry : paSet) {			PartyAttribute pa = new PartyAttribute();			pa.set("party_id", id).set("attr_name", entry.getKey()).set("attr_value", entry.getValue()).save();		}		index();	}}